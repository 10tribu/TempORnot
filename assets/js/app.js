const Prix2025 = {
    EDF: {
        "Bleu": {
            abonnement: {
				6: 168.48,
				9: 216.12,
				12: 260.28,
				15: 301.92,
				18: 344.88,
				24: 434.76,
				30: 503.52,
				36: 584.64
            },
            prix: {
				hp: 0.2146,
				hc: 0.1696
            }
        },
        "Zen Fixe": {
            abonnement: {
				6: 180.24,
				9: 216.12,
				12: 260.28,
				15: 301.92,
				18: 344.88,
				24: 434.76,
				30: 503.52,
				36: 584.64
            },
            prix: {
				hp: 0.2028,
				hc: 0.1608
            }
        },
        Tempo: {
            abonnement: {
                6: 167.64,
                9: 209.4,
                12: 251.52,
                15: 290.76,
                18: 330,
                24: 495.24,
                30: 495.24,
                36: 581.4
            },
            prix: {
                bleu: { hp: 0.1552, hc: 0.1288 },
                blanc: { hp: 0.1792, hc: 0.1447 },
                rouge: { hp: 0.6586, hc: 0.1518 }
            }
		},
        "Tempo (Aout 25)": {
            abonnement: {
                6: 190.62,
                9: 238.06,
                12: 286.07,
                15: 330.63,
                18: 375.33,
                24: 547.39,
                30: 563.36,
                36: 661.40
            },
            prix: {
                bleu: { hp: 0.1507, hc: 0.1243 },
                blanc: { hp: 0.1747, hc: 0.1403 },
                rouge: { hp: 0.6541, hc: 0.1473 }
            }
		},
		"Zen Online": {
			abonnement: {
				6: 158.52,
				9: 204.12,
				12: 246.12,
				15: 286.32,
				18: 326.04,
				24: 399.60,
				30: 473.16,
				36: 547.44
			},
			prix: {
				hp: 0.2622,
				hc: 0.2048
            }
        }
    },
    "Total Energies": {
        "Verte Fixe": {
            abonnement: {
                6: 159.37,
                9: 201.84,
                12: 258.6,
                15: 282.87,
                18: 322.06,
                24: 404.36,
                30: 479.31,
                36: 554.9
            },
            prix: {
                hp: 0.2118,
                hc: 0.1675
            }
        },
		"HeuresEco": {
            abonnement: {
                6: 169.24,
                9: 213.87,
                12: 257.36,
                15: 298.45,
                18: 340.8,
                24: 429.55,
                30: 509.7,
                36: 592.12
            },
            prix: {
                hp: 0.2146,
                hc: 0.1696
            }
		},
		"Standard Fixe": {
			abonnement: {
				6: 184.32,
				9: 233.16,
				12: 280.32,
				15: 324.48,
				18: 370.20,
				24: 467.04,
				30: 552.60,
				36: 641.16
			},
			prix: {
				hp: 0.2022,
				hc: 0.1604
            }
        }
    },
    "Octopus Energy": {
        "Eco Conso Fixe": {
            abonnement: {
				6: 168.48,
				9: 216.12,
				12: 260.28,
				15: 301.92,
				18: 344.88,
				24: 434.76,
				30: 516.00,
				36: 584.64
            },
            prix: {
				hp: 0.2093,
				hc: 0.1657
            }
		} ,
		"Happy Charge": {
            abonnement: {
				6: 168.48,
				9: 216.12,
				12: 260.28,
				15: 301.92,
				18: 344.88,
				24: 434.76,
				30: 516.00,
				36: 584.64
            },
            prix: {
				hp: 0.2215,
				hc: 0.131
            }
        }
    },
    Engie: {
        "Elec Référence 2ans": {
            abonnement: {
                6: 164.59,
                9: 209.68,
                12: 253.76,
                15: 295.94,
                18: 337.74,
                24: 425.27,
                30: 505.44,
                36: 586.25
            },
            prix: {
                hp: 0.2201,
                hc: 0.1757
            }
        },
        "Elec Tranquillité 1 an HC": {
            abonnement: {
                6: 152.54,
                9: 191.48,
                12: 231.19,
                15: 268.23,
                18: 305.02,
                24: 386.45,
                30: 455.98,
                36: 537.79
            },
            prix: {
                hp: 0.2729,
                hc: 0.2089
			}
		}
	},
	"Enercoop": {
		"Electricité 100% Renouvelable": {
		  abonnement: {
			6: 234.24,
			9: 313.32,
			12: 384.12,
			15: 454.8,
			18: 525.6,
			24: 667.08,
			30: 808.56,
			36: 950.28
		  },
		  prix: {
			hp: 0.2744,
			hc: 0.1901
            }
        }
    },
    "La Bellenergie": {
        Prudence: {
            abonnement: {
                6: 157.21,
                9: 199.69,
                12: 257.64,
                15: 280.72,
                18: 319.91,
                24: 402.21,
                30: 477.16,
                36: 552.75
            },
            prix: {
                hp: 0.2058,
                hc: 0.1631
            }
        }
    },
    "Mint Energie": {
        "Online Green": {
            abonnement: {
				6: 171.00,
				9: 216.12,
				12: 260.28,
				15: 301.92,
				18: 344.88,
				24: 434.76,
				30: 516.12,
				36: 599.64
            },
            prix: {
				hp: 0.1971,
				hc: 0.1566
            }
        }
    },
    ES: {
        Tempo: {
            abonnement: {
                6: 167.64,
                9: 209.4,
                12: 251.52,
                15: 290.76,
                18: 330,
                24: 495.24,
                30: 495.24,
                36: 581.4
            },
            prix: {
                bleu: { hp: 0.1552, hc: 0.1288 },
                blanc: { hp: 0.1792, hc: 0.1447 },
                rouge: { hp: 0.6586, hc: 0.1518 }
			}
		}
	},
	Alterna: {
		"Verte 100% Fr": {
			abonnement: {
				6: 168.48,
				9: 216.12,
				12: 260.28,
				15: 301.92,
				18: 344.88,
				24: 434.76,
				30: 516.00,
				36: 599.64
			},
			prix: {
				hp: 0.2059,
				hc: 0.1631
            }
        }
    },
    Alpiq: {
		"Stable": {
			abonnement: {
				6: 168.48,
				9: 214.92,
				12: 260.28,
				15: 301.92,
				18: 344.88,
				24: 434.76,
				30: 503.52,
				36: 584.64
			},
			prix: {
				hp: 0.2093,
				hc: 0.1657
			}
		},   
		"Classique": {
            abonnement: {
                6: 168.48,
                9: 214.92,
                12: 260.28,
                15: 301.92,
                18: 344.88,
                24: 434.76,
                30: 503.52,
                36: 584.64
            },
            prix: {
                hp: 0.2076,
                hc: 0.1644
            }
        }
    },
    Sowee: {
        "Élec' Optim - Heures Creuses": {
            abonnement: {
                6: 168.48,
                9: 214.92,
                12: 260.28,
                15: 301.92,
                18: 344.88,
                24: 434.76,
                30: 503.52,
                36: 584.64
            },
            prix: {
                hp: 0.2933,
                hc: 0.224
			}
		}
	},
	"Ekwateur": {
		"Voiture Electrique": {
			abonnement: {
				6: 222.36,
				9: 259.44,
				12: 305.76,
				15: 345.12,
				18: 389.40,
				24: 477.84,
				30: 560.04,
				36: 645.12
			},
			prix: {
				hp: 0.2443,
				hc: 0.1486
			}
		}
	},
	"Elmy": {
		"Fixe 100 Verte Francaise": {
			abonnement: {
				6: 183.00,
				9: 230.64,
				12: 279.12,
				15: 323.64,
				18: 369.36,
				24: 465.48,
				30: 546.00,
				36: 633.72
			},
			prix: {
				hp: 0.2085,
				hc: 0.1650
			}
		}
	},
	"Plenitude": {
		"Plenifix 1 an": {
			abonnement: {
				6: 196.25,
				9: 232.53,
				12: 275.61,
				15: 315.77,
				18: 354.04,
				24: 441.46,
				30: 529.26,
				36: 606.05
			},
			prix: {
				hp: 0.1972,
				hc: 0.1567
			}
		}
	},
	"OHM Energie": {
		"Extra Eco": {
			abonnement: {
				6: 170.88,
				9: 216.12,
				12: 260.28,
				15: 301.92,
				18: 344.88,
				24: 434.76,
				30: 516.00,
				36: 599.64
			},
			prix: {
				hp: 0.1966,
				hc: 0.1563
			}
		}
	},
	"Ilek": {
		"Offre": {
		  abonnement: {
			6: 168.48,
			9: 216.12,
			12: 260.28,
			15: 301.92,
			18: 344.88,
			24: 434.76,
			30: 503.52,
			36: 584.64
		  },
		  prix: {
			hp: 0.2146,
			hc: 0.1696
		  }
		}
    },
    "Vattenfall": {
	"Équilibre Verte -5%": {
	  abonnement: {
		6: 176.64,
		9: 221.64,
		12: 266.64,
		15: 311.64,
		18: 356.64,
		24: 456.64,
		30: 556.64,
		36: 656.64
	  },
	  prix: {
		hp: 0.2058,
		hc: 0.1631
            }
        }
    }
}; 





// Définition de la variable fournisseurs
const fournisseurs = Prix2025;
// Déclarer des variables globales pour stocker les instances des graphiques
let chartCoutMensuel = null;
let chartRepartitionCouts = null;
// Variables globales pour les paramètres du graphique de coût mensuel
let coefficientsSaisonnalite = {
    'Janvier': 1.4,
    'Février': 1.3,
    'Mars': 1.1,
    'Avril': 0.9,
    'Mai': 0.7,
    'Juin': 0.6,
    'Juillet': 0.5,
    'Août': 0.5,
    'Septembre': 0.7,
    'Octobre': 0.9,
    'Novembre': 1.1,
    'Décembre': 1.3
};
let repartitionJoursRouges = {
    'Janvier': 8,      // ~8 jours rouges en janvier
    'Février': 6,      // ~6 jours rouges en février
    'Mars': 0,         // 0 jours rouges en mars
    'Avril': 0,        // Pas de jours rouges
    'Mai': 0,          // Pas de jours rouges
    'Juin': 0,         // Pas de jours rouges
    'Juillet': 0,      // Pas de jours rouges
    'Août': 0,         // Pas de jours rouges
    'Septembre': 0,    // Pas de jours rouges
    'Octobre': 0,      // Pas de jours rouges
    'Novembre': 3,     // ~3 jours rouges en novembre
    'Décembre': 5      // ~5 jours rouges en décembre
};
let repartitionJoursBlancs = {
    'Janvier': 7,      // ~7 jours blancs en janvier
    'Février': 6,      // ~6 jours blancs en février
    'Mars': 4,         // ~4 jours blancs en mars
    'Avril': 3,        // ~3 jours blancs en avril
    'Mai': 3,          // ~3 jours blancs en mai
    'Juin': 0,         // 0 jours blancs en juin
    'Juillet': 0,      // 0 jours blancs en juillet
    'Août': 0,         // 0 jours blancs en août
    'Septembre': 4,    // ~4 jours blancs en septembre
    'Octobre': 4,      // ~4 jours blancs en octobre
    'Novembre': 5,     // ~5 jours blancs en novembre
    'Décembre': 7      // ~7 jours blancs en décembre
};
// Fonction de sauvegarde déplacée au niveau global pour être accessible partout
function sauvegarderValeurs() {
    const valeurs = {
        fournisseur: $('#fournisseur').val(),
        contrat: $('#contrat').val(),
        abonnement: $('#abonnement').val(),
        hp: $('#hp').val(),
        hc: $('#hc').val(),
        hpBleu: $('#hpBleu').val(),
        hcBleu: $('#hcBleu').val(),
        hpBlanc: $('#hpBlanc').val(),
        hcBlanc: $('#hcBlanc').val(),
        hpRouge: $('#hpRouge').val(),
        hcRouge: $('#hcRouge').val(),
        tempoPourcentages: {
            hpBleu: $('.tempo-percentage[data-type="hp"][data-color="Bleu"]').val(),
            hcBleu: $('.tempo-percentage[data-type="hc"][data-color="Bleu"]').val(),
            hpBlanc: $('.tempo-percentage[data-type="hp"][data-color="Blanc"]').val(),
            hcBlanc: $('.tempo-percentage[data-type="hc"][data-color="Blanc"]').val(),
            hpRouge: $('.tempo-percentage[data-type="hp"][data-color="Rouge"]').val(),
            hcRouge: $('.tempo-percentage[data-type="hc"][data-color="Rouge"]').val()
        }
    };
    localStorage.setItem('comparateurElectricite', JSON.stringify(valeurs));
}
$(document).ready(function() {
    // Initialiser le thème
    initTheme();
    
    // Charger les valeurs sauvegardées
    chargerValeursSauvegardees();
    
    // Charger les paramètres du graphique de coût mensuel
    chargerParametresCoutMensuel();
    
    // Initialiser les fournisseurs
    updateFournisseurs();
    
    // Gérer l'importation des coefficients de saisonnalité
    $('#importCoefficients').on('change', function(e) {
        
        const fichier = e.target.files[0];
        if (fichier) {
            
            importerCoefficients(fichier);
            // Réinitialiser l'input file pour permettre de sélectionner le même fichier à nouveau
            $(this).val('');
        }
    });
    
    // Gérer le clic sur le bouton de réinitialisation
    $('#reinitialiserButton').on('click', function() {
        // Supprimer toutes les données du localStorage
        localStorage.clear();
        // OU spécifiquement pour notre clé
        localStorage.removeItem('comparateurEnergie');
        
        // Réafficher le bouton d'ajout de fournisseur personnalisé
        $('#addCustomFournisseur').removeClass('hidden');
        
        // Recharger la page pour s'assurer d'un état initial propre
        window.location.reload();
    });

    // Remplir le select des fournisseurs
    Object.keys(Prix2025).forEach(fournisseur => {
        $('#fournisseur').append(`<option value="${fournisseur}">${fournisseur}</option>`);
    });

    // Gestionnaire d'événements pour le changement de fournisseur
    $('#fournisseur').change(function() {
        const fournisseur = $(this).val();
        if (fournisseur) {
            // Cacher le select et afficher le label
            $(this).addClass('hidden');
            $('#fournisseurLabel').text(fournisseur).removeClass('hidden');
            
            // Cacher le bouton d'ajout de fournisseur personnalisé
            $('#addCustomFournisseur').addClass('hidden');
            
            // Afficher le select du contrat
            $('#contratContainer').removeClass('hidden');
            $('#contratSelect').removeClass('hidden');
            $('#contratLabel').addClass('hidden');
            updateContrats(fournisseur);

            // Mettre à jour les calculs et sauvegarder
            updateCalculsEtSauvegarde();
        }
    });

    // Gestionnaire pour le changement de contrat
    $('#contrat').change(function() {
        const contrat = $(this).val();
        const fournisseur = $('#fournisseur').val();
        
        if (contrat && fournisseur) {
            // Mettre à jour les options d'abonnement disponibles
            updateAbonnementOptions(fournisseur, contrat);
            
            // Afficher le conteneur d'abonnement
            $('#abonnementContainer').removeClass('hidden');
            
            // Afficher/masquer les champs Tempo si nécessaire
            $('#tempoContainer').toggleClass('hidden', contrat !== 'Tempo');
            
            // Cacher le select et afficher le label
            $(this).addClass('hidden');
            $('#contratLabel').text(contrat).removeClass('hidden');
        }
    });

    // Gestionnaire pour le changement d'abonnement
    $('#abonnement').change(function() {
        const abonnement = $(this).val();
        if (abonnement) {
            // Cacher le select et afficher le label
            $(this).addClass('hidden');
            $('#abonnementLabel').text(`${abonnement} kVA`).removeClass('hidden');
            
            $('#consommationContainer').removeClass('hidden');
            $('#inputsContainer').removeClass('hidden');

            // Mettre à jour les calculs et sauvegarder
            updateCalculsEtSauvegarde();
        }
    });

    // Modifier le gestionnaire de clic sur les labels
    $('.select-label').click(function(e) {
        const targetId = $(this).data('for');
        const $select = $(`#${targetId}`);
        
        // Vérifier si le clic est sur l'icône d'édition
        const clickX = e.pageX - $(this).offset().left;
        const labelWidth = $(this).width();
        
        if (clickX > labelWidth - 30) {
            // Si c'est le select d'abonnement, réinitialiser sa valeur
            if (targetId === 'abonnement') {
                $select.val('');
            }
            
            // Cacher le label et montrer le select
            $(this).addClass('hidden');
            $select.removeClass('hidden');
            
            // Cacher les résultats existants
            $('#resultatContainerWrapper').addClass('hidden');
            $('#analysesContainer').addClass('hidden');
            
            // Si on modifie un select précédent, cacher les suivants
            if (targetId === 'fournisseur') {
                $('#contratContainer, #abonnementContainer, #consommationContainer').addClass('hidden');
            } else if (targetId === 'contrat') {
                $('#abonnementContainer, #consommationContainer').addClass('hidden');
            } else if (targetId === 'abonnement') {
                $('#consommationContainer').addClass('hidden');
            }
        }
    });
    // Modifier le gestionnaire pour le bouton de calcul
    $('#calculerButton').click(function() {
        const puissance = $('#abonnement').val();
        const contratSelectionne = $('#contrat').val();
        const fournisseurSelectionne = $('#fournisseur').val();
        if (!puissance || !contratSelectionne || !fournisseurSelectionne) return;
        // Afficher le loader avec le texte approprié
        $('.loader-text').text('Calcul en cours...');
        $('#loader').removeClass('hidden').css('display', 'flex');
        // Cacher les selects et afficher les labels
        $('.select-input').addClass('hidden');
        $('#fournisseurLabel').text($('#fournisseur').val()).removeClass('hidden');
        $('#contratLabel').text($('#contrat').val()).removeClass('hidden');
        $('#abonnementLabel').text($('#abonnement').val() + ' kVA').removeClass('hidden');
        // Utiliser setTimeout pour simuler un délai et permettre au loader de s'afficher
        setTimeout(() => {
        // Calculer et afficher les résultats
        calculerEtAfficherComparaison();
        
        // Afficher le tableau des résultats
        $('#resultatContainerWrapper').removeClass('hidden');

        // Collapse des paramètres
        collapseSettings();

            // Cacher le loader
            $('#loader').addClass('hidden').css('display', 'none');
        }, 800); // Augmenter légèrement le délai pour une meilleure expérience utilisateur
    });

    // Gestionnaires pour les inputs Tempo
    $('#hpBleu, #hcBleu, #hpBlanc, #hcBlanc, #hpRouge, #hcRouge').on('input', function() {
        if ($('#contrat').val() === 'Tempo') {
            synchroniserInputsTempo();
            verifierInputs();
            sauvegarderValeurs(); // Sauvegarder après modification
        }
    });

    // Gestionnaires pour HP/HC globaux
    $('#hp, #hc').on('input', function() {
        if ($('#contrat').val() === 'Tempo') {
            synchroniserInputsTempo();
            verifierInputs();
            sauvegarderValeurs(); // Sauvegarder après modification
        }
    });

    // Nouvelle fonction pour mettre à jour les calculs et sauvegarder
    function updateCalculsEtSauvegarde() {
        // Sauvegarder les valeurs
        const hp = Number($('#hp').val());
        const hc = Number($('#hc').val());
        const contrat = $('#contrat').val();

        // Calculer les valeurs Tempo si nécessaire
        let tempoValues = {};
        if (contrat === 'Tempo') {
            // Répartition Tempo : 82% Bleu, 12% Blanc, 6% Rouge
            tempoValues = {
                hpBleu: Math.round(hp * 0.82),
                hcBleu: Math.round(hc * 0.82),
                hpBlanc: Math.round(hp * 0.12),
                hcBlanc: Math.round(hc * 0.12),
                hpRouge: Math.round(hp * 0.06),
                hcRouge: Math.round(hc * 0.06)
            };
            // Mettre à jour les champs Tempo
            $('#hpBleu').val(tempoValues.hpBleu);
            $('#hcBleu').val(tempoValues.hcBleu);
            $('#hpBlanc').val(tempoValues.hpBlanc);
            $('#hcBlanc').val(tempoValues.hcBlanc);
            $('#hpRouge').val(tempoValues.hpRouge);
            $('#hcRouge').val(tempoValues.hcRouge);
        }
        const valeurs = {
            fournisseur: $('#fournisseur').val(),
            contrat: contrat,
            abonnement: $('#abonnement').val(),
            hp: hp,
            hc: hc,
            tempoValues  // Ajouter les valeurs Tempo si elles existent
        };
        localStorage.setItem('comparateurEnergie', JSON.stringify(valeurs));

        // Vérifier si les inputs sont remplis pour afficher le bouton
        verifierInputs();
        
        // Mettre à jour les pourcentages
        updatePourcentages();
    }

    // Ajouter des gestionnaires pour tous les champs qui nécessitent une sauvegarde
    $('#fournisseur, #contrat, #abonnement, #hp, #hc, #hpBleu, #hcBleu, #hpBlanc, #hcBlanc, #hpRouge, #hcRouge')
        .on('change input', function() {
            updateCalculsEtSauvegarde();
        });

    // Cacher les analyses supplémentaires au démarrage
    $('#analysesContainer').addClass('hidden');

    // Gestionnaire pour le changement de thème
    $('input[name="theme"]').change(function() {
        const theme = $(this).val();
        setTheme(theme);
        localStorage.setItem('theme', theme);
    });

    // Gestionnaire pour le bouton d'affichage/masquage des statistiques
    $('#toggleStatsButton').on('click', function() {
        const button = $(this);
        const analysesContainer = $('#analysesContainer');
        const resultatContainer = $('#resultatContainer');

        if (analysesContainer.hasClass('hidden')) {
            // Masquer le tableau et afficher les statistiques
            resultatContainer.fadeOut(300, function() {
                $(this).addClass('hidden');
                analysesContainer.fadeIn(300).removeClass('hidden');
                
                // Mettre à jour le bouton
                button.html('<i class="fas fa-table mr-3"></i>Afficher le tableau')
                    .removeClass('bg-blue-500 hover:bg-blue-700')
                    .addClass('bg-green-500 hover:bg-green-700');
            });
        } else {
            // Masquer les statistiques et afficher le tableau
            analysesContainer.fadeOut(300, function() {
                $(this).addClass('hidden');
                resultatContainer.fadeIn(300).removeClass('hidden');
                
                // Mettre à jour le bouton
                button.html('<i class="fas fa-chart-bar mr-3"></i>Afficher les stats')
                    .removeClass('bg-green-500 hover:bg-green-700')
                    .addClass('bg-blue-500 hover:bg-blue-700');
            });
        }
    });

    // Gestionnaires pour tous les champs de consommation
    $('#hp, #hc, #hpBleu, #hcBleu, #hpBlanc, #hcBlanc, #hpRouge, #hcRouge').on('input', function() {
        verifierInputs();
        if ($('#contrat').val() === 'Tempo') {
            synchroniserInputsTempo();
        }
    });

    // Gestionnaire pour le collapse des paramètres
    $('#toggleSettings').click(function() {
        toggleSettings();
    });

    // Gestionnaire pour le bouton d'ajout de fournisseur personnalisé
    $('#addCustomFournisseur').click(function() {
        $('#customFournisseurModal').removeClass('hidden');
    });

    // Gestionnaire pour le bouton d'annulation
    $('#cancelCustomFournisseur').click(function() {
        $('#customFournisseurModal').addClass('hidden');
    });

    // Gestionnaire pour le formulaire
    $('#customFournisseurForm').submit(function(e) {
        e.preventDefault();
        
        const customFournisseur = {
            name: $('#customFournisseurName').val(),
            contrat: $('#customContratName').val(),
            abonnement: {
                6: Number($('#customAbo6').val()),
                9: Number($('#customAbo9').val()),
                12: Number($('#customAbo12').val()),
                15: Number($('#customAbo15').val()),
                // ... autres puissances
            },
            prix: {
                hp: Number($('#customHP').val()),
                hc: Number($('#customHC').val())
            }
        };

        // Ajouter le fournisseur personnalisé à Prix2025
        if (!Prix2025[customFournisseur.name]) {
            Prix2025[customFournisseur.name] = {};
        }
        Prix2025[customFournisseur.name][customFournisseur.contrat] = {
            abonnement: customFournisseur.abonnement,
            prix: customFournisseur.prix
        };

        // Mettre à jour le select des fournisseurs
        updateFournisseurs();
        
        // Fermer le modal
        $('#customFournisseurModal').addClass('hidden');
        
        // Réinitialiser le formulaire
        this.reset();
    });

    // Fonction pour mettre à jour la liste des fournisseurs
    function updateFournisseurs() {
        const $select = $('#fournisseur');
        const currentValue = $select.val();
        
        $select.empty().append('<option value="">Sélectionnez</option>');
        
        Object.keys(Prix2025).sort().forEach(fournisseur => {
            $select.append(`<option value="${fournisseur}">${fournisseur}</option>`);
        });
        
        if (currentValue) {
            $select.val(currentValue);
        }
    }

    // Gestionnaire pour le toggle du disclaimer
    $('#disclaimerToggle').click(function() {
        $('#disclaimer').toggleClass('hidden');
    });

    // Gestionnaire pour les pourcentages Tempo
    $('.tempo-percentage').on('input', function() {
        const type = $(this).data('type'); // 'hp' ou 'hc'
        const color = $(this).data('color'); // 'Bleu', 'Blanc' ou 'Rouge'
        const percentage = Number($(this).val() || 0);
        
        // Récupérer les valeurs HP/HC globales
        const totalHP = Number($('#hp').val() || 0);
        const totalHC = Number($('#hc').val() || 0);
        
        // Calculer la nouvelle valeur basée sur le pourcentage
        const newValue = Math[type === 'hp' ? 'round' : 'round'](
            (type === 'hp' ? totalHP : totalHC) * (percentage / 100)
        );
        
        // Mettre à jour le champ correspondant
        $(`#${type}${color}`).val(newValue).trigger('input');
    });

    // Gestionnaire pour le bouton de nettoyage du cache
    $('#clearCacheButton').on('click', function() {
        // Afficher le loader avec un message spécifique
        $('#loader').css('display', 'flex').find('.loader-text').text('Nettoyage du cache...');
        
        setTimeout(() => {
            try {
                if ('caches' in window) {
                    // Supprimer tous les caches
                    caches.keys().then(cacheNames => {
                        return Promise.all(
                            cacheNames.map(cacheName => {
                                return caches.delete(cacheName);
                            })
                        );
                    }).then(() => {
                        // Désinscrire les service workers
                        if ('serviceWorker' in navigator) {
                            navigator.serviceWorker.getRegistrations().then(registrations => {
                                for (let registration of registrations) {
                                    registration.unregister();
                                }
                            });
                        }
                        
                        // Afficher un message de succès
                        $('#loader .loader-text').text('Cache nettoyé avec succès!');
                        setTimeout(() => {
                            $('#loader').hide();
                            // Recharger la page après un court délai
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        }, 1000);
                    });
        } else {
                    // L'API Cache n'est pas disponible
                    $('#loader .loader-text').text('Cache API non disponible');
                    setTimeout(() => {
                        $('#loader').hide();
                    }, 1500);
                }
            } catch (error) {
                console.error('Erreur lors du nettoyage du cache:', error);
                $('#loader .loader-text').text('Erreur lors du nettoyage');
                setTimeout(() => {
                    $('#loader').hide();
                }, 1500);
            }
        }, 100);
    });

    // Gestionnaire pour le bouton des paramètres du graphique de coût mensuel
    $('#coutMensuelSettingsBtn').on('click', function() {
        // Remplir les champs avec les valeurs actuelles
        remplirChampsCoutMensuelSettings();
        // Mettre à jour les totaux
        updateTotalJoursTempoModal();
        // Afficher la modale
        $('#coutMensuelSettingsModal').removeClass('hidden');
    });

    // Gestionnaires pour fermer la modale
    $(document).on('click', '#closeCoutMensuelSettings, #cancelCoutMensuelSettings', function() {
        $('#coutMensuelSettingsModal').addClass('hidden');
    });

    // Gestionnaire pour réinitialiser les paramètres
    $(document).on('click', '#resetCoutMensuelSettings', function() {
        // Réinitialiser les coefficients de saisonnalité
        coefficientsSaisonnalite = {
            'Janvier': 1.4, 'Février': 1.3, 'Mars': 1.1, 'Avril': 0.9,
            'Mai': 0.7, 'Juin': 0.6, 'Juillet': 0.5, 'Août': 0.5,
            'Septembre': 0.7, 'Octobre': 0.9, 'Novembre': 1.2, 'Décembre': 1.4
        };

        // Réinitialiser la répartition des jours rouges
        repartitionJoursRouges = {
            'Janvier': 8, 'Février': 6, 'Mars': 0, 'Avril': 0,
            'Mai': 0, 'Juin': 0, 'Juillet': 0, 'Août': 0,
            'Septembre': 0, 'Octobre': 0, 'Novembre': 3, 'Décembre': 5
        };

        // Réinitialiser la répartition des jours blancs
        repartitionJoursBlancs = {
            'Janvier': 7, 'Février': 6, 'Mars': 4, 'Avril': 3,
            'Mai': 3, 'Juin': 0, 'Juillet': 0, 'Août': 0,
            'Septembre': 4, 'Octobre': 4, 'Novembre': 5, 'Décembre': 7
        };

        // Mettre à jour les champs
        remplirChampsCoutMensuelSettings();
        
        // Mettre à jour les totaux
        updateTotalJoursTempoModal();
    });

    // Gestionnaire pour sauvegarder les paramètres
    $(document).on('click', '#saveCoutMensuelSettings', function() {
        // Vérifier les totaux des jours Tempo
        const totalRouges = Object.values(repartitionJoursRouges).reduce((a, b) => a + b, 0);
        const totalBlancs = Object.values(repartitionJoursBlancs).reduce((a, b) => a + b, 0);
        
        if (totalRouges !== 22) {
            alert('Le total des jours rouges doit être égal à 22.');
            return;
        }
        
        if (totalBlancs !== 43) {
            alert('Le total des jours blancs doit être égal à 43.');
            return;
        }
        
        // Récupérer les valeurs des coefficients de saisonnalité
        const mois = Object.keys(coefficientsSaisonnalite);
        mois.forEach(mois => {
            const moisFormatted = mois.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            coefficientsSaisonnalite[mois] = parseFloat($(`#coef-${moisFormatted}`).val());
        });
        
        // Récupérer les valeurs des jours rouges
        ['Novembre', 'Décembre', 'Janvier', 'Février', 'Mars'].forEach(mois => {
            const moisFormatted = mois.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            repartitionJoursRouges[mois] = parseInt($(`#rouge-${moisFormatted}`).val());
        });
        
        // Récupérer les valeurs des jours blancs
        mois.forEach(mois => {
            const moisFormatted = mois.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            repartitionJoursBlancs[mois] = parseInt($(`#blanc-${moisFormatted}`).val());
        });
        
        // Sauvegarder les paramètres dans localStorage
        sauvegarderParametresCoutMensuel();
        
        // Fermer la modale
        $('#coutMensuelSettingsModal').addClass('hidden');
        
        // Vérifier si le graphique existe déjà
        if (chartCoutMensuel) {
           
            // Récupérer les résultats actuels depuis localStorage
            const resultatsStr = localStorage.getItem('dernierResultat');
            
            if (resultatsStr) {
                try {
                    const resultats = JSON.parse(resultatsStr);
                    
                    if (resultats && resultats.length > 0) {
                        
                        // Trouver la meilleure offre (première position dans le tableau)
                        const meilleurOffre = resultats[0];
                        
                        // Mettre à jour le graphique
                        if (typeof creerGraphiqueCoutMensuel === 'function') {
                            creerGraphiqueCoutMensuel(meilleurOffre, resultats);
                            
                            // Afficher un message de confirmation
                            const message = $('<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">')
                                .html('<strong class="font-bold">Succès!</strong> <span class="block sm:inline">Les paramètres ont été mis à jour et le graphique a été actualisé.</span>')
                                .prependTo('#analysesContainer')
                                .delay(3000)
                                .fadeOut(500, function() {
                                    $(this).remove();
                                });
                        } else {
                            console.error("La fonction creerGraphiqueCoutMensuel n'est pas définie");
                        }
                    } else {
                        console.error("Aucun résultat trouvé ou tableau vide");
                    }
                } catch (e) {
                    console.error("Erreur lors du parsing des résultats:", e);
                }
            } else {
                console.error("Aucun résultat trouvé dans localStorage");
                
                // Si aucun résultat n'est trouvé dans localStorage mais que le graphique existe,
                // on peut essayer de récupérer les données directement depuis le graphique
                if (chartCoutMensuel && chartCoutMensuel.data && chartCoutMensuel.data.datasets && chartCoutMensuel.data.datasets.length >= 2) {
                   
                    // Recréer le graphique avec les mêmes données mais les nouveaux paramètres
                    const datasets = chartCoutMensuel.data.datasets;
                    const labels = chartCoutMensuel.data.labels;
                    
                    // Détruire le graphique existant
                    chartCoutMensuel.destroy();
                    
                    // Créer un nouveau graphique avec les mêmes données
                    chartCoutMensuel = new Chart(document.getElementById('coutMensuelChart').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: chartCoutMensuel.options
                    });
                    
                    // Afficher un message de confirmation
                    const message = $('<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">')
                        .html('<strong class="font-bold">Succès!</strong> <span class="block sm:inline">Les paramètres ont été mis à jour.</span>')
                        .prependTo('#analysesContainer')
                        .delay(3000)
                        .fadeOut(500, function() {
                            $(this).remove();
                        });
                } else {
                    // Afficher un message d'erreur
                    const message = $('<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">')
                        .html('<strong class="font-bold">Erreur!</strong> <span class="block sm:inline">Impossible de mettre à jour le graphique. Veuillez relancer une comparaison.</span>')
                        .prependTo('#analysesContainer')
                        .delay(5000)
                        .fadeOut(500, function() {
                            $(this).remove();
                        });
                }
            }
        } else {
            console.error("Le graphique n'existe pas encore");
            
            // Afficher un message d'erreur
            const message = $('<div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative mb-4" role="alert">')
                .html('<strong class="font-bold">Attention!</strong> <span class="block sm:inline">Les paramètres ont été sauvegardés mais aucun graphique n\'est disponible. Veuillez lancer une comparaison.</span>')
                .prependTo('#analysesContainer')
                .delay(5000)
                .fadeOut(500, function() {
                    $(this).remove();
                });
        }
    });

    // Gestionnaires pour mettre à jour les totaux des jours Tempo
    $(document).on('input', '[id^=rouge-], [id^=blanc-]', function() {
        updateTotalJoursTempoModal();
    });

    // Initialiser les fournisseurs
    updateFournisseurs();

    // Ajouter un gestionnaire pour le bouton d'exportation
    $(document).on('click', '#exportCoefficients', function() {
        exporterCoefficients();
    });
    
    // Gestionnaire pour le bouton d'exportation au format compatible
    $(document).on('click', '#exportCompatible', function() {
        const formatExterne = exporterFormatCompatible();
        
        // Convertir en JSON
        const jsonString = JSON.stringify(formatExterne, null, 2);
        
        // Créer un blob et un lien de téléchargement
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Créer un lien temporaire pour le téléchargement
        const a = document.createElement('a');
        a.href = url;
        a.download = 'coefficients_format_alternatif.json';
        document.body.appendChild(a);
        a.click();
        
        // Nettoyer
    setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 0);
    });

    // Vérifier l'état des conteneurs après le chargement
    setTimeout(verifierEtatConteneurs, 1000);
    
    // Ajouter un gestionnaire d'événements supplémentaire pour le bouton
    $('#toggleStatsButton').off('click.debug').on('click.debug', function() {
        setTimeout(verifierEtatConteneurs, 600);
    });
});

function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'auto';
}

function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'auto';
    $(`input[name="theme"][value="${savedTheme}"]`).prop('checked', true);
    setTheme(savedTheme);

    // Écouter les changements de thème système
    if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addListener(function(e) {
            if (localStorage.getItem('theme') === 'auto') {
                setTheme('auto');
            }
        });
    }
}

function setTheme(theme) {
    const isDark = theme === 'dark' || 
                  (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
    if (isDark) {
        $('html').addClass('dark');
    } else {
        $('html').removeClass('dark');
    }
}

// Fonctions utilitaires
function updateContrats(fournisseur) {
    const contrats = Object.keys(Prix2025[fournisseur]);
    $('#contrat').empty().append('<option value="">Sélectionnez un contrat</option>');
    contrats.forEach(contrat => {
        $('#contrat').append(`<option value="${contrat}">${contrat}</option>`);
    });
}

function updateAbonnementOptions(fournisseur, contrat) {
    const $abonnement = $('#abonnement');
    const abonnements = Prix2025[fournisseur][contrat].abonnement;
    
    // Parcourir toutes les options d'abonnement
    $abonnement.find('option').each(function() {
        const value = $(this).val();
        if (!value) return; // Ignorer l'option "Sélectionnez"
        
        // Désactiver l'option si l'abonnement n'est pas défini pour ce contrat
        const isDisabled = !abonnements[value];
        $(this).prop('disabled', isDisabled);
        
        // Ajouter une classe pour le style et un titre explicatif si désactivé
        if (isDisabled) {
            $(this).addClass('text-gray-400');
            $(this).attr('title', 'Non disponible pour ce contrat');
        } else {
            $(this).removeClass('text-gray-400');
            $(this).removeAttr('title');
        }
    });
    
    // Si l'abonnement actuellement sélectionné n'est pas disponible, réinitialiser la sélection
    if ($abonnement.val() && !abonnements[$abonnement.val()]) {
        $abonnement.val('');
    }
}

function synchroniserInputsTempo() {
    const hp = Number($('#hp').val() || 0);
    const hc = Number($('#hc').val() || 0);

    // Ne synchroniser que si les champs HP/HC globaux sont modifiés
    if (document.activeElement.id === 'hp' || document.activeElement.id === 'hc') {
        // Répartition Tempo : 82% Bleu, 12% Blanc, 6% Rouge
        $('#hpBleu').val(Math.round(hp * 0.82));
        $('#hcBleu').val(Math.round(hc * 0.82));
        $('#hpBlanc').val(Math.round(hp * 0.12));
        $('#hcBlanc').val(Math.round(hc * 0.12));
        $('#hpRouge').val(Math.round(hp * 0.06));
        $('#hcRouge').val(Math.round(hc * 0.06));
    } else {
        // Si on modifie directement les champs Tempo, mettre à jour les totaux HP/HC
        const totalHP = Number($('#hpBleu').val() || 0) + 
                       Number($('#hpBlanc').val() || 0) + 
                       Number($('#hpRouge').val() || 0);
        const totalHC = Number($('#hcBleu').val() || 0) + 
                       Number($('#hcBlanc').val() || 0) + 
                       Number($('#hcRouge').val() || 0);
        
        $('#hp').val(totalHP);
        $('#hc').val(totalHC);
    }

    // Mettre à jour les pourcentages
    updatePourcentages();
}

function calculerCoutContrat(fournisseur, contrat, puissance, consommation) {
    const tarifContrat = Prix2025[fournisseur][contrat];
    const coutAbonnement = tarifContrat.abonnement[puissance];
    let coutConsommation = 0;
    let detailsCouts = {};

    const hp = Number(consommation.hp || 0);
    const hc = Number(consommation.hc || 0);

    if (contrat === 'Tempo' && tarifContrat.prix.bleu) {
        // Répartition correcte des consommations Tempo
        const consos = {
            bleu: {
                hc: Number($('#hcBleu').val()) || hc * 0.82,
                hp: Number($('#hpBleu').val()) || hp * 0.82
            },
            blanc: {
                hc: Number($('#hcBlanc').val()) || hc * 0.12,
                hp: Number($('#hpBlanc').val()) || hp * 0.12
            },
            rouge: {
                hc: Number($('#hcRouge').val()) || hc * 0.06,
                hp: Number($('#hpRouge').val()) || hp * 0.06
            }
        };

        // Calcul du coût total avec les bonnes proportions
        coutConsommation = Object.entries(consos).reduce((total, [couleur, { hc, hp }]) => {
            return total + hc * tarifContrat.prix[couleur].hc + hp * tarifContrat.prix[couleur].hp;
        }, 0);

        // Stocker les détails pour l'affichage
        detailsCouts = {
            bleu: {
                hp: consos.bleu.hp * tarifContrat.prix.bleu.hp,
                hc: consos.bleu.hc * tarifContrat.prix.bleu.hc
            },
            blanc: {
                hp: consos.blanc.hp * tarifContrat.prix.blanc.hp,
                hc: consos.blanc.hc * tarifContrat.prix.blanc.hc
            },
            rouge: {
                hp: consos.rouge.hp * tarifContrat.prix.rouge.hp,
                hc: consos.rouge.hc * tarifContrat.prix.rouge.hc
            }
        };
    } else {
        // Pour les contrats non-Tempo
        if (tarifContrat.prix && tarifContrat.prix.hp && tarifContrat.prix.hc) {
            detailsCouts = {
                standard: {
                    hp: hp * tarifContrat.prix.hp,
                    hc: hc * tarifContrat.prix.hc
                }
            };
            coutConsommation = detailsCouts.standard.hp + detailsCouts.standard.hc;
        }
    }

    return {
        fournisseur,
        contrat,
        coutAbonnement,
        coutConsommation,
        coutTotal: coutAbonnement + coutConsommation,
        details: {
            hp: hp,
            hc: hc,
            total: hp + hc
        },
        detailsCouts
    };
}

function calculerEtAfficherStatistiques(consommation) {
    const totalKwh = consommation.hp + consommation.hc;
    
    // Calcul des pourcentages
    const pourcentageHP = (consommation.hp / totalKwh) * 100;
    const pourcentageHC = (consommation.hc / totalKwh) * 100;
    
    // Mise à jour des barres de progression
    $('#hpPourcentage').css('width', `${pourcentageHP}%`);
    $('#hcPourcentage').css('width', `${pourcentageHC}%`);
    $('#hpPourcentageText').text(`${pourcentageHP.toFixed(1)}%`);
    $('#hcPourcentageText').text(`${pourcentageHC.toFixed(1)}%`);

    // Calculer les moyennes
    calculerMoyennes(consommation);

    // Si c'est un contrat Tempo
    if ($('#contrat').val() === 'Tempo') {
        
        
        // Calcul des pourcentages Tempo
        const totalTempoHP = consommation.hpBleu + consommation.hpBlanc + consommation.hpRouge;
        const totalTempoHC = consommation.hcBleu + consommation.hcBlanc + consommation.hcRouge;
        
        // Mise à jour des pourcentages pour chaque période
        updateTempoPourcentage('Bleu', consommation.hpBleu, consommation.hcBleu, totalKwh);
        updateTempoPourcentage('Blanc', consommation.hpBlanc, consommation.hcBlanc, totalKwh);
        updateTempoPourcentage('Rouge', consommation.hpRouge, consommation.hcRouge, totalKwh);
    } else {
        
    }
}

function updateTempoPourcentage(couleur, hp, hc, total) {
    const pourcentageHP = (hp / total) * 100;
    const pourcentageHC = (hc / total) * 100;
    
    $(`#hp${couleur}Pourcentage`).css('width', `${pourcentageHP}%`);
    $(`#hc${couleur}Pourcentage`).css('width', `${pourcentageHC}%`);
    $(`#hp${couleur}PourcentageText`).text(`${pourcentageHP.toFixed(1)}%`);
    $(`#hc${couleur}PourcentageText`).text(`${pourcentageHC.toFixed(1)}%`);
}

function calculerStatistiquesSupplementaires(resultats, consommation) {
    const meilleurOffre = resultats[0];
    const offreSelectionnee = resultats.find(r => 
        r.fournisseur === $('#fournisseur').val() && 
        r.contrat === $('#contrat').val()
    );
    
    // Calculer le total des kWh
    let totalKwh = 0;
    if (consommation.hp && consommation.hc) {
        totalKwh = Number(consommation.hp) + Number(consommation.hc);
    } else {
        // Pour Tempo
        totalKwh = (Number(consommation.hpBleu) + Number(consommation.hcBleu) +
                    Number(consommation.hpBlanc) + Number(consommation.hcBlanc) +
                    Number(consommation.hpRouge) + Number(consommation.hcRouge));
    }

    // Calcul des statistiques
    const coutMoyenKwhSelect = offreSelectionnee.coutTotal / totalKwh;
    const coutMoyenKwhBest = meilleurOffre.coutTotal / totalKwh;
    const partAbonnementSelect = (offreSelectionnee.coutAbonnement / offreSelectionnee.coutTotal * 100);
    const partConsommationSelect = (offreSelectionnee.coutConsommation / offreSelectionnee.coutTotal * 100);
    const partAbonnementBest = (meilleurOffre.coutAbonnement / meilleurOffre.coutTotal * 100);
    const partConsommationBest = (meilleurOffre.coutConsommation / meilleurOffre.coutTotal * 100);

    // Mise à jour du HTML des statistiques détaillées
    const statsHtml = `
        <div class="grid grid-cols-3 gap-4">
            <div class="font-medium">
                <i class="fas fa-chart-line mr-2"></i>Critère
            </div>
            <div class="font-medium text-blue-600">
                <i class="fas fa-check-circle mr-2"></i>Votre offre 
            </div>
            <div class="font-medium text-green-600">
                <i class="fas fa-star mr-2"></i>Meilleure offre
            </div>

            <div>
                <i class="fas fa-bolt mr-2"></i>Conso. totale
            </div>
            <div class="text-blue-600" colspan="2">${totalKwh.toLocaleString()} kWh/an</div>
            <div class="text-green-600" colspan="2">${totalKwh.toLocaleString()} kWh/an</div>
            <div>
                <i class="fas fa-euro-sign mr-2"></i>Coût moyen / kWh
            </div>
            <div class="text-blue-600">${coutMoyenKwhSelect.toFixed(4)} €/kWh</div>
            <div class="text-green-600">${coutMoyenKwhBest.toFixed(4)} €/kWh</div>

            <div>
                <i class="fas fa-file-invoice-dollar mr-2"></i>Abonnement
            </div>
            <div class="text-blue-600">${partAbonnementSelect.toFixed(1)}%</div>
            <div class="text-green-600">${partAbonnementBest.toFixed(1)}%</div>

            <div>
                <i class="fas fa-bolt mr-2"></i>Consommation
            </div>
            <div class="text-blue-600">${partConsommationSelect.toFixed(1)}%</div>
            <div class="text-green-600">${partConsommationBest.toFixed(1)}%</div>
        </div>
    `;

    $('#statsDetailContainer').html(statsHtml);

    // S'assurer que les conteneurs de moyennes sont visibles
    $('#moyenneJournaliere, #moyenneHoraire').removeClass('hidden');
    
    // Calculer les moyennes de consommation
    calculerMoyennes(consommation);

    // Créer les graphiques
    creerGraphiqueCoutMensuel(meilleurOffre, resultats);
    creerGraphiqueRepartitionCouts(resultats);
}

function creerGraphiqueCoutMensuel(meilleurOffre, resultats) {
    // Détruire le graphique existant s'il y en a un
    if (chartCoutMensuel) {
        chartCoutMensuel.destroy();
    }

    // Sauvegarder les résultats pour pouvoir recréer le graphique après modification des paramètres
    localStorage.setItem('dernierResultat', JSON.stringify(resultats));
    
    // Trouver l'offre sélectionnée
    const offreSelectionnee = resultats.find(r => 
        r.fournisseur === $('#fournisseur').val() && 
        r.contrat === $('#contrat').val()
    ) || meilleurOffre; // Utiliser la meilleure offre si l'offre sélectionnée n'est pas trouvée
    
    // Nombre de jours par mois pour calculer les jours bleus
    const joursParMois = {
        'Janvier': 31,
        'Février': 28, // On simplifie en prenant 28 jours pour février
        'Mars': 31,
        'Avril': 30,
        'Mai': 31,
        'Juin': 30,
        'Juillet': 31,
        'Août': 31,
        'Septembre': 30,
        'Octobre': 31,
        'Novembre': 30,
        'Décembre': 31
    };
    
    // Utiliser les variables globales au lieu de redéfinir des variables locales
    // Ces variables sont modifiées par la modale des paramètres
    const mois = Object.keys(coefficientsSaisonnalite);
    
    // Calculer les coûts mensuels en tenant compte de la saisonnalité et de la répartition Tempo
    let coutsMensuelsNormalises = [];
    let coutsMensuelsNormalisesMeilleur = [];
    
    // Vérifier si l'offre sélectionnée est un contrat Tempo
    const isTempoSelected = offreSelectionnee.contrat === 'Tempo';
    const isTempoMeilleur = meilleurOffre.contrat === 'Tempo';
    
    mois.forEach((mois, index) => {
        // Calculer le coût mensuel de base avec saisonnalité
        let coutMensuel = offreSelectionnee.coutTotal / 12 * coefficientsSaisonnalite[mois];
        let coutMensuelMeilleur = meilleurOffre.coutTotal / 12 * coefficientsSaisonnalite[mois];
        
        // Ajuster pour les contrats Tempo
        if (isTempoSelected) {
            // Calculer le nombre de jours bleus dans ce mois
            const joursBleus = joursParMois[mois] - repartitionJoursRouges[mois] - repartitionJoursBlancs[mois];
            
            // Calculer la proportion de consommation pour chaque type de jour
            const proportionRouge = repartitionJoursRouges[mois] / joursParMois[mois];
            const proportionBlanc = repartitionJoursBlancs[mois] / joursParMois[mois];
            const proportionBleu = joursBleus / joursParMois[mois];
            
            // Ajuster le coût mensuel en fonction de la répartition des jours Tempo
            // Les jours rouges sont beaucoup plus chers, surtout en HP
            const facteurAjustement = 1 + (proportionRouge * 1.5) - (proportionBleu * 0.2);
            coutMensuel *= facteurAjustement;
        }
        
        if (isTempoMeilleur) {
            // Même logique pour la meilleure offre si c'est un contrat Tempo
            const joursBleus = joursParMois[mois] - repartitionJoursRouges[mois] - repartitionJoursBlancs[mois];
            const proportionRouge = repartitionJoursRouges[mois] / joursParMois[mois];
            const proportionBlanc = repartitionJoursBlancs[mois] / joursParMois[mois];
            const proportionBleu = joursBleus / joursParMois[mois];
            const facteurAjustement = 1 + (proportionRouge * 1.5) - (proportionBleu * 0.2);
            coutMensuelMeilleur *= facteurAjustement;
        }
        
        coutsMensuelsNormalises.push(coutMensuel);
        coutsMensuelsNormalisesMeilleur.push(coutMensuelMeilleur);
    });
    
    // Normaliser pour que la somme soit égale au coût annuel total
    const sommeNormalisee = coutsMensuelsNormalises.reduce((a, b) => a + b, 0);
    const sommeNormaliseeMeilleur = coutsMensuelsNormalisesMeilleur.reduce((a, b) => a + b, 0);
    
    // Calculer les totaux ajustés qui reflètent l'impact des paramètres de saisonnalité et jours Tempo
    const totalAjusteOffre = sommeNormalisee;
    const totalAjusteMeilleur = sommeNormaliseeMeilleur;
    
    // Créer le conteneur de total avant le graphique
    const totalContainer = document.createElement('div');
    totalContainer.id = 'coutMensuelTotalContainer';
    totalContainer.className = 'mb-4 p-3 bg-gray-50 rounded-lg flex flex-col space-y-2';
    
    // Calculer la différence entre les totaux ajustés
    const differenceAjustee = Math.abs(totalAjusteOffre - totalAjusteMeilleur);
    const pourcentageAjuste = ((differenceAjustee / totalAjusteMeilleur) * 100).toFixed(1);
    
    // Remplir le conteneur avec les totaux standards et ajustés
    totalContainer.innerHTML = `
        <div class="flex justify-between items-center">
        <div class="flex items-center">
                <span class="font-medium">Total :</span>
            </div>
            <div class="flex items-center">
                <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: rgba(59, 130, 246, 0.7)"></span>
                <span class="font-medium">${offreSelectionnee.fournisseur} | ${offreSelectionnee.contrat} :</span>
                <span class="ml-2 font-bold">${offreSelectionnee.coutTotal.toFixed(2)}€/an</span>
            </div>
            <div class="flex items-center">
                <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: rgba(16, 185, 129, 0.7)"></span>
                <span class="font-medium">${meilleurOffre.fournisseur} | ${meilleurOffre.contrat} :</span>
                <span class="ml-2 font-bold">${meilleurOffre.coutTotal.toFixed(2)}€/an</span>
            </div>
            <div class="flex items-center">
                <span class="font-medium">Différence :</span>
                <span class="ml-2 font-bold ${offreSelectionnee.coutTotal > meilleurOffre.coutTotal ? 'text-red-500' : 'text-green-500'}">
                    ${Math.abs(offreSelectionnee.coutTotal - meilleurOffre.coutTotal).toFixed(2)}€/an
                    (${((Math.abs(offreSelectionnee.coutTotal - meilleurOffre.coutTotal) / meilleurOffre.coutTotal) * 100).toFixed(1)}%)
                </span>
            </div>
        </div>
        <div class="flex justify-between items-center pt-2 border-t border-gray-200">
            <div class="flex items-center">
                <span class="font-medium">Total (ajusté) :</span>
            </div>
            <div class="flex items-center">
                <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: rgba(59, 130, 246, 0.7)"></span>
                <span id="totalAjusteOffre" class="font-bold">${offreSelectionnee.contrat} | ${totalAjusteOffre.toFixed(2)}€/an</span>
            </div>
            <div class="flex items-center">
                <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: rgba(16, 185, 129, 0.7)"></span>
                <span id="totalAjusteMeilleur" class="font-bold">${meilleurOffre.contrat} | ${totalAjusteMeilleur.toFixed(2)}€/an</span>
            </div>
            <div class="flex items-center">
                <span class="font-medium">Diff. (ajustée) :</span>
                <span class="ml-2 font-bold ${totalAjusteOffre > totalAjusteMeilleur ? 'text-red-500' : 'text-green-500'}">
                    ${differenceAjustee.toFixed(2)}€/an (${pourcentageAjuste}%)
                </span>
            </div>
        </div>
    `;
    
    // Supprimer l'ancien conteneur de total s'il existe
    const oldTotalContainer = document.getElementById('coutMensuelTotalContainer');
    if (oldTotalContainer) {
        oldTotalContainer.remove();
    }
    
    // Ajouter le conteneur avant le canvas du graphique
    const chartCanvas = document.getElementById('coutMensuelChart');
    const chartContainer = chartCanvas.parentNode;
    chartContainer.insertBefore(totalContainer, chartCanvas);
    
    const ctx = chartCanvas.getContext('2d');
    
    // Normaliser les coûts mensuels pour que leur somme soit égale au coût annuel total
    coutsMensuelsNormalises = coutsMensuelsNormalises.map(cout => 
        cout * (offreSelectionnee.coutTotal / sommeNormalisee)
    );
    
    coutsMensuelsNormalisesMeilleur = coutsMensuelsNormalisesMeilleur.map(cout => 
        cout * (meilleurOffre.coutTotal / sommeNormaliseeMeilleur)
    );
    
    // Créer le graphique
    chartCoutMensuel = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: mois,
            datasets: [
                {
                    label: `${offreSelectionnee.fournisseur} - ${offreSelectionnee.contrat}`,
                    data: coutsMensuelsNormalises,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                },
                {
                    label: `${meilleurOffre.fournisseur} - ${meilleurOffre.contrat}`,
                    data: coutsMensuelsNormalisesMeilleur,
                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                    borderColor: 'rgb(16, 185, 129)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const moisIndex = context.dataIndex;
                            const moisActuel = mois[moisIndex];
                            let infoSupplementaire = '';
                            
                            // Ajouter des informations sur les jours Tempo dans l'infobulle
                            if ((context.datasetIndex === 0 && isTempoSelected) || 
                                (context.datasetIndex === 1 && isTempoMeilleur)) {
                                const joursRouges = repartitionJoursRouges[moisActuel];
                                const joursBlancs = repartitionJoursBlancs[moisActuel];
                                const joursBleus = joursParMois[moisActuel] - joursRouges - joursBlancs;
                                
                                infoSupplementaire = ` (${joursBleus}j bleus, ${joursBlancs}j blancs, ${joursRouges}j rouges)`;
                            }
                            
                            return `${context.dataset.label}: ${context.raw.toFixed(2)}€${infoSupplementaire}`;
                        }
                    }
                },
                legend: {
                    position: 'top',
                    labels: {
                        boxWidth: 12,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                title: {
                    display: true,
                    text: 'Estimation du coût mensuel avec saisonnalité et jours Tempo',
                    font: {
                        size: 14
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Coût (€)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '€';
                        }
                    }
                }
            }
        }
    });
}

function creerGraphiqueRepartitionCouts(resultats) {
    const ctx = document.getElementById('repartitionCoutsChart').getContext('2d');
    
    // Détruire le graphique existant s'il y en a un
    if (chartRepartitionCouts) {
        chartRepartitionCouts.destroy();
    }

    const offreSelectionnee = resultats.find(r => 
        r.fournisseur === $('#fournisseur').val() && 
        r.contrat === $('#contrat').val()
    );
    
    // Définir les couleurs pour les différentes catégories
    const colors = {
        abonnement: 'rgb(16, 185, 129)', // vert
        hp: 'rgb(239, 68, 176)',          // rose
        hc: 'rgb(112, 59, 246)',         // violet
        hpBleu: 'rgb(96, 165, 250)',     // bleu clair
        hcBleu: 'rgb(147, 197, 253)',    // bleu très clair
        hpBlanc: 'rgb(209, 213, 219)',   // gris
        hcBlanc: 'rgb(229, 231, 235)',   // gris clair
        hpRouge: 'rgb(248, 113, 113)',   // rouge clair
        hcRouge: 'rgb(254, 202, 202)'    // rouge très clair
    };

    // Préparer les datasets en fonction du type de contrat
    let datasets = [];
    
    // Toujours ajouter l'abonnement
    datasets.push({
        label: 'Abonnement',
        data: [offreSelectionnee.coutAbonnement, resultats[0].coutAbonnement],
        backgroundColor: colors.abonnement,
        stack: 'Stack 0'
    });

    // Vérifier si c'est un contrat Tempo
    if (offreSelectionnee.contrat === 'Tempo' && offreSelectionnee.detailsCouts.bleu) {
        // Pour l'offre sélectionnée (Tempo)
        const detailsOffre = offreSelectionnee.detailsCouts;
        
        // Ajouter les détails pour chaque période Tempo
        datasets.push({
            label: 'HP Bleu',
            data: [detailsOffre.bleu.hp, 0],
            backgroundColor: colors.hpBleu,
            stack: 'Stack 0'
        });
        datasets.push({
            label: 'HC Bleu',
            data: [detailsOffre.bleu.hc, 0],
            backgroundColor: colors.hcBleu,
            stack: 'Stack 0'
        });
        datasets.push({
            label: 'HP Blanc',
            data: [detailsOffre.blanc.hp, 0],
            backgroundColor: colors.hpBlanc,
            stack: 'Stack 0'
        });
        datasets.push({
            label: 'HC Blanc',
            data: [detailsOffre.blanc.hc, 0],
            backgroundColor: colors.hcBlanc,
            stack: 'Stack 0'
        });
        datasets.push({
            label: 'HP Rouge',
            data: [detailsOffre.rouge.hp, 0],
            backgroundColor: colors.hpRouge,
            stack: 'Stack 0'
        });
        datasets.push({
            label: 'HC Rouge',
            data: [detailsOffre.rouge.hc, 0],
            backgroundColor: colors.hcRouge,
            stack: 'Stack 0'
        });
        
        // Pour la meilleure offre
        if (resultats[0].contrat === 'Tempo' && resultats[0].detailsCouts.bleu) {
            // Si la meilleure offre est aussi Tempo
            const detailsMeilleure = resultats[0].detailsCouts;
            datasets[1].data[1] = detailsMeilleure.bleu.hp;
            datasets[2].data[1] = detailsMeilleure.bleu.hc;
            datasets[3].data[1] = detailsMeilleure.blanc.hp;
            datasets[4].data[1] = detailsMeilleure.blanc.hc;
            datasets[5].data[1] = detailsMeilleure.rouge.hp;
            datasets[6].data[1] = detailsMeilleure.rouge.hc;
        } else {
            // Si la meilleure offre n'est pas Tempo, ajouter HP/HC standard
            datasets.push({
                label: 'HP',
                data: [0, resultats[0].detailsCouts.standard.hp],
                backgroundColor: colors.hp,
                stack: 'Stack 0'
            });
            datasets.push({
                label: 'HC',
                data: [0, resultats[0].detailsCouts.standard.hc],
                backgroundColor: colors.hc,
                stack: 'Stack 0'
            });
        }
    } else {
        // Pour les contrats standard
        datasets.push({
            label: 'HP',
            data: [offreSelectionnee.detailsCouts.standard.hp, 0],
            backgroundColor: colors.hp,
            stack: 'Stack 0'
        });
        datasets.push({
            label: 'HC',
            data: [offreSelectionnee.detailsCouts.standard.hc, 0],
            backgroundColor: colors.hc,
            stack: 'Stack 0'
        });
        
        // Pour la meilleure offre
        if (resultats[0].contrat === 'Tempo' && resultats[0].detailsCouts.bleu) {
            // Si la meilleure offre est Tempo
            const detailsMeilleure = resultats[0].detailsCouts;
            datasets.push({
                label: 'HP Bleu',
                data: [0, detailsMeilleure.bleu.hp],
                backgroundColor: colors.hpBleu,
                stack: 'Stack 0'
            });
            datasets.push({
                label: 'HC Bleu',
                data: [0, detailsMeilleure.bleu.hc],
                backgroundColor: colors.hcBleu,
                stack: 'Stack 0'
            });
            datasets.push({
                label: 'HP Blanc',
                data: [0, detailsMeilleure.blanc.hp],
                backgroundColor: colors.hpBlanc,
                stack: 'Stack 0'
            });
            datasets.push({
                label: 'HC Blanc',
                data: [0, detailsMeilleure.blanc.hc],
                backgroundColor: colors.hcBlanc,
                stack: 'Stack 0'
            });
            datasets.push({
                label: 'HP Rouge',
                data: [0, detailsMeilleure.rouge.hp],
                backgroundColor: colors.hpRouge,
                stack: 'Stack 0'
            });
            datasets.push({
                label: 'HC Rouge',
                data: [0, detailsMeilleure.rouge.hc],
                backgroundColor: colors.hcRouge,
                stack: 'Stack 0'
            });
        } else {
            // Si la meilleure offre est aussi standard
            datasets[1].data[1] = resultats[0].detailsCouts.standard.hp;
            datasets[2].data[1] = resultats[0].detailsCouts.standard.hc;
        }
    }
    
    // Créer le nouveau graphique
    chartRepartitionCouts = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Votre offre', 'Meilleure offre'],
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + ' €';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const total = context.dataset.stack === 'Stack 0' 
                                ? offreSelectionnee.coutTotal 
                                : resultats[0].coutTotal;
                            const percentage = (value / total * 100).toFixed(1);
                            return `${context.dataset.label}: ${value.toFixed(2)} € (${percentage}%)`;
                        }
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 10,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

function calculerEtAfficherComparaison() {
    // Afficher le loader
    $('#loader').css('display', 'flex').find('.loader-text').text('Calcul en cours...');
    
    // Utiliser setTimeout pour permettre au loader de s'afficher avant le calcul
    setTimeout(() => {
        try {
            // Récupérer les valeurs
            const fournisseur = $('#fournisseur').val();
            const contrat = $('#contrat').val();
            const puissance = parseInt($('#abonnement').val());
            
            // Récupérer les consommations
            let consommation = {};
            if ($('#tempoContainer').is(':visible')) {
                // Pour Tempo, on utilise les valeurs détaillées
                consommation = {
                    hp: parseFloat($('#hp').val()) || 0,
                    hc: parseFloat($('#hc').val()) || 0,
                    hpBleu: parseFloat($('#hpBleu').val()) || 0,
                    hcBleu: parseFloat($('#hcBleu').val()) || 0,
                    hpBlanc: parseFloat($('#hpBlanc').val()) || 0,
                    hcBlanc: parseFloat($('#hcBlanc').val()) || 0,
                    hpRouge: parseFloat($('#hpRouge').val()) || 0,
                    hcRouge: parseFloat($('#hcRouge').val()) || 0
                };
    } else {
                // Pour les contrats standard
                consommation = {
                    hp: parseFloat($('#hp').val()) || 0,
                    hc: parseFloat($('#hc').val()) || 0
                };
            }
            
            // Calculer les coûts pour tous les contrats
    const resultats = [];

            // Parcourir tous les fournisseurs
            Object.keys(fournisseurs).forEach(nomFournisseur => {
                // Parcourir tous les contrats du fournisseur
                Object.keys(fournisseurs[nomFournisseur]).forEach(nomContrat => {
                    // Vérifier si le contrat est disponible pour la puissance sélectionnée
                    if (fournisseurs[nomFournisseur][nomContrat].abonnement && 
                        fournisseurs[nomFournisseur][nomContrat].abonnement[puissance]) {
                        // Calculer le coût pour ce contrat
                        const resultat = calculerCoutContrat(nomFournisseur, nomContrat, puissance, consommation);
                        resultats.push(resultat);
                    }
        });
    });

            // Trier les résultats par coût total
    resultats.sort((a, b) => a.coutTotal - b.coutTotal);
    
            // Marquer le contrat le moins cher
            if (resultats.length > 0) {
                resultats[0].isCheapest = true;
    
                // Calculer la différence par rapport au moins cher
                const coutMinimum = resultats[0].coutTotal;
    resultats.forEach(r => {
        r.difference = r.coutTotal - coutMinimum;
    });

                // Marquer le contrat actuel de l'utilisateur
                resultats.forEach(r => {
                    r.isUserContract = (r.fournisseur === fournisseur && r.contrat === contrat);
                });
        
        // Afficher les résultats
        afficherResultats(resultats, consommation);
        
                // Calculer et afficher les statistiques supplémentaires
                calculerStatistiquesSupplementaires(resultats, consommation);
                
                // Sauvegarder les valeurs
                sauvegarderValeurs();
                
                // Afficher le bouton de réinitialisation
                $('#reinitialiserButton').removeClass('hidden');
                
                // Ajouter le bouton d'export
                ajouterBoutonExport(resultats);
    } else {
                // Aucun résultat trouvé
                $('#loader .loader-text').text('Aucun contrat disponible pour cette puissance');
                setTimeout(() => {
                    $('#loader').hide();
                }, 1500);
            }
            
            // Masquer le loader après un court délai pour une meilleure UX
            setTimeout(() => {
                $('#loader').hide();
            }, 300);
    } catch (error) {
            console.error('Erreur lors du calcul:', error);
            // Afficher un message d'erreur dans le loader
            $('#loader .loader-text').text('Erreur lors du calcul: ' + error.message);
            setTimeout(() => {
                $('#loader').hide();
            }, 1500);
        }
    }, 100);
}

function afficherResultats(resultats, consommation) {
    const table = $('#comparaisonTable');
    table.empty();

    const fournisseurSelectionne = $('#fournisseur').val();
    const contratSelectionne = $('#contrat').val();

    // En-têtes avec icônes
    const headers = `
        <thead class="bg-gray-50 sticky top-0 z-40 text-l shadow-xl uppercase">
            <tr>
                <th scope="row"  class="px-2 py-3 text-center text-xs font-medium text-gray-500 whitespace-nowrap">
                    <i class="fas fa-building mr-1"></i>Fournisseur - Contrat
                </th>
                <th scope="row" class="px-2 py-3 text-center text-xs font-medium text-gray-500 whitespace-nowrap">
                    Coût Abonnement
                </th>
                <th scope="row" class="px-2 py-3 text-center text-xs font-medium text-gray-500 whitespace-nowrap">
                    Coût kWh
                </th>
                <th scope="row" class="px-2 py-3 text-center text-xs font-medium text-gray-500 whitespace-nowrap">
                    Coût Total
                </th>
                <th scope="row" class="px-2 py-3 text-center text-xs font-medium text-gray-500 whitespace-nowrap">
                    <i class="fas fa-exchange-alt mr-1"></i>Différence
                </th>
            </tr>
        </thead>
    `;

    const rows = resultats.map((r, index) => {
        const isSelected = r.fournisseur === fournisseurSelectionne && r.contrat === contratSelectionne;
        
        // Ajouter la classe tempo si c'est un contrat Tempo
        const rowClass = `border-b ${isSelected ? 'mycontract' : ''} ${r.isCheapest ? 'cheapest bg-green-50' : ''} ${r.contrat === 'Tempo' ? 'tempo' : ''}`.trim();
    
        

        // Générer le détail des coûts en fonction du type de contrat
        let detailCoutsHtml = '';
        if (r.contrat === 'Tempo') {
            // Calculer les totaux HP et HC
            const totalHP = r.detailsCouts.bleu.hp + r.detailsCouts.blanc.hp + r.detailsCouts.rouge.hp;
            const totalHC = r.detailsCouts.bleu.hc + r.detailsCouts.blanc.hc + r.detailsCouts.rouge.hc;

            detailCoutsHtml = `
                <div class="flex flex-col items-end">
                    <div class="mb-2">
                        HP : ${totalHP.toFixed(2)}<sup><i class="fas fa-euro-sign ml-1"></i>/ an</sup>
                        <div class="tooltip-container inline-block ml-2">
                            <i class="fas fa-circle-info text-white"></i>
                            <div class="tooltip-text text-left bg-gray-700 p-2 rounded" style="min-width: 130px; z-index: 1000; left: 100%; top: 50%; transform: translateY(-50%); margin-left: 8px;">
                                <div class="bg-blue-400 p-2 mb-1 rounded text-white">
                                    <small>HP Bleu : ${r.detailsCouts.bleu.hp.toFixed(2)} €/an</small>
                                </div>
                                <div class="bg-gray-400 p-2 mb-1 rounded text-white">
                                    <small>HP Blanc : ${r.detailsCouts.blanc.hp.toFixed(2)} €/an</small>
                                </div>
                                <div class="bg-red-400 p-2 rounded text-white">
                                    <small>HP Rouge : ${r.detailsCouts.rouge.hp.toFixed(2)} €/an</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        HC : ${totalHC.toFixed(2)}<sup><i class="fas fa-euro-sign ml-1"></i>/ an</sup>
                        <div class="tooltip-container inline-block ml-2">
                            <i class="fas fa-circle-info text-white"></i>
                            <div class="tooltip-text text-left bg-gray-700 p-2 rounded" style="min-width: 130px; z-index: 1000; left: 100%; top: 50%; transform: translateY(-50%); margin-left: 8px;">
                                <div class="bg-blue-400 p-2 mb-1 rounded text-white">
                                    <small>HC Bleu : ${r.detailsCouts.bleu.hc.toFixed(2)} €/an</small>
                                </div>
                                <div class="bg-gray-400 p-2 mb-1 rounded text-white">
                                    <small>HC Blanc : ${r.detailsCouts.blanc.hc.toFixed(2)} €/an</small>
                                </div>
                                <div class="bg-red-400 p-2 rounded text-white">
                                    <small>HC Rouge : ${r.detailsCouts.rouge.hc.toFixed(2)} €/an</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            detailCoutsHtml = `
                HP : ${r.detailsCouts.standard.hp.toFixed(2)}<sup><i class="fas fa-euro-sign ml-1"></i>/ an</sup><br>
                HC : ${r.detailsCouts.standard.hc.toFixed(2)}<sup><i class="fas fa-euro-sign ml-1"></i>/ an</sup>
            `;
        }

        // Calculer le pourcentage par rapport au moins cher
        const coutMinimum = Math.min(...resultats.map(item => item.coutTotal));
        const pourcentage = ((r.coutTotal - coutMinimum) / coutMinimum * 100).toFixed(1);

        // Contenu de la cellule de différence avec tooltip
        let differenceContent = '';
        if (r.isCheapest) {
            differenceContent = '<span class="py-6 block"><i class="fa-solid fa-medal"></i> Contrat le moins cher</span>';
        } else {
            differenceContent = `
                <div class="tooltip-container">
                    <span class="total"><i class="fa-solid fa-plus"></i> ${r.difference.toFixed(2)}<sup><i class="fas fa-euro-sign ml-1"></i>/ an</sup></span>
                    <span class="tooltip-text">+ ${pourcentage}% de plus</span>
                </div>
                <sup> par rapport <br>au contrat <br>le moins cher</sup>
            `;
        }

        return `
            <tr class="${rowClass} text-xl">
                <td class="fournisseur px-1 py-1 bg-gray-400/50 whitespace-nowrap"> ${r.fournisseur} <small>${r.contrat}</small></td>
                <td class="coutabo px-1 py-1 text-right text-sm">${r.coutAbonnement.toFixed(2)} <sup><i class="fas fa-euro-sign ml-1"></i>/ an</sup></td>
                <td class="detail px-1 py-1 text-right text-sm whitespace-nowrap"> ${detailCoutsHtml}</td>
                <td class="couttotal px-1 py-1 text-right font-medium whitespace-nowrap">
                    <div class="tooltip-container">
                        ${r.coutTotal.toFixed(2)} <sup><i class="fas fa-euro-sign ml-1"></i>/ an</sup>
                        <div class="tooltip-text">
                            <div class="">
                                <small>Mensualité : ${(r.coutTotal / 12).toFixed(2)} €/mois</small>
                            </div>
                        </div>
                    </div>
                </td>
                <td class="difference px-1 py-1 text-center ${r.isCheapest ? 'text-white bg-green-800/50' : 'chere text-white bg-orange-800/50'} whitespace-nowrap diff-cell" data-percentage="${pourcentage}">
                    ${differenceContent}
                </td>
            </tr>
        `;
    }).join('');

    table.html(`
        ${headers}
        <tbody class="bg-white">
            ${rows}
        </tbody>
    `);

    $('#resultatContainerWrapper').removeClass('hidden');

    // S'assurer que le tableau est visible et les statistiques sont masquées
    $('#resultatContainer').removeClass('hidden').show();
    $('#analysesContainer').addClass('hidden').hide();
    $('#toggleStatsButton')
        .html('<i class="fas fa-chart-bar mr-3"></i>Afficher les stats')
        .removeClass('bg-green-500 hover:bg-green-700')
        .addClass('bg-blue-500 hover:bg-blue-700')
        .show();
    
    // Rendre visible le conteneur principal
    $('#resultatContainerWrapper').removeClass('hidden').show();

    // Passer les résultats à la fonction
    ajouterBoutonExport(resultats);
}

function chargerValeursSauvegardees() {
    const valeurs = JSON.parse(localStorage.getItem('comparateurEnergie'));
    if (valeurs) {
        // Si un fournisseur est sauvegardé, cacher le bouton d'ajout
        if (valeurs.fournisseur) {
            $('#addCustomFournisseur').addClass('hidden');
        }
        
        // Restaurer les valeurs
        $('#fournisseur').val(valeurs.fournisseur).trigger('change');
        
        setTimeout(() => {
            $('#contrat').val(valeurs.contrat).trigger('change');
            $('#abonnement').val(valeurs.abonnement);
            $('#hp').val(valeurs.hp);
            $('#hc').val(valeurs.hc);

            // Restaurer les valeurs Tempo
            if (valeurs.contrat === 'Tempo') {
                $('#hpBleu').val(valeurs.hpBleu);
                $('#hcBleu').val(valeurs.hcBleu);
                $('#hpBlanc').val(valeurs.hpBlanc);
                $('#hcBlanc').val(valeurs.hcBlanc);
                $('#hpRouge').val(valeurs.hpRouge);
                $('#hcRouge').val(valeurs.hcRouge);
                
                // Mettre à jour les pourcentages Tempo
                updatePourcentages();
            }

            // Si tous les champs nécessaires sont remplis
            if (valeurs.fournisseur && valeurs.contrat && valeurs.abonnement) {
                $('#inputsContainer').removeClass('hidden');
                // Vérifier uniquement si les inputs sont remplis pour afficher le bouton
                verifierInputs();
            }
        }, 100);
    }
}

function reinitialiserFormulaire() {
    // Supprimer les données du localStorage
    localStorage.removeItem('comparateurEnergie');

    // Réinitialiser tous les champs
    $('#fournisseur').val('').trigger('change');
    $('#contrat, #abonnement').val('');
    $('#hp, #hc').val('');
    $('#hpBleu, #hcBleu, #hpBlanc, #hcBlanc, #hpRouge, #hcRouge').val('');

    // Réinitialiser les pourcentages et barres de progression
    $('#hpPourcentage, #hcPourcentage').css('width', '0%');
    $('#hpPourcentageText, #hcPourcentageText').text('0%');
    $('#hpBleuPourcentage, #hcBleuPourcentage, #hpBlancPourcentage, #hcBlancPourcentage, #hpRougePourcentage, #hcRougePourcentage')
        .css('width', '0%');
    $('#hpBleuPourcentageText, #hcBleuPourcentageText, #hpBlancPourcentageText, #hcBlancPourcentageText, #hpRougePourcentageText, #hcRougePourcentageText')
        .text('0%');

    // Cacher les conteneurs
    $('#contratContainer, #abonnementContainer, #consommationContainer').addClass('hidden');
    $('#inputsContainer').addClass('hidden');
    $('#buttonsContainer').addClass('hidden');
    $('#tempoContainer').addClass('hidden');
    $('#resultatContainerWrapper').addClass('hidden');
    $('#analysesContainer').addClass('hidden');

    // Réinitialiser l'affichage des selects/labels
    $('.select-input').removeClass('hidden');
    $('.select-label').addClass('hidden');

    // Détruire les graphiques existants
    if (chartCoutMensuel) {
        chartCoutMensuel.destroy();
        chartCoutMensuel = null;
    }
    if (chartRepartitionCouts) {
        chartRepartitionCouts.destroy();
        chartRepartitionCouts = null;
    }
}

// Modifier la fonction verifierInputs
function verifierInputs() {
    const contrat = $('#contrat').val();
    
    if (contrat === 'Tempo') {
        const tempoInputs = [
            $('#hpBleu').val(),
            $('#hcBleu').val(),
            $('#hpBlanc').val(),
            $('#hcBlanc').val(),
            $('#hpRouge').val(),
            $('#hcRouge').val()
        ];
        
        // Vérifier si au moins un champ Tempo est rempli
        const hasTempoValue = tempoInputs.some(val => val && Number(val) > 0);
        $('#buttonsContainer').toggleClass('hidden', !hasTempoValue);
        $('#reinitialiserButton').toggleClass('hidden', !hasTempoValue);
    } else {
        // Pour les autres contrats, vérifier HP/HC globaux
        const hp = $('#hp').val();
        const hc = $('#hc').val();
        const hasValue = hp && hc && Number(hp) > 0 && Number(hc) > 0;
        $('#buttonsContainer').toggleClass('hidden', !hasValue);
        $('#reinitialiserButton').toggleClass('hidden', !hasValue);
    }
}

function ajouterBoutonExport(resultats) {
    // Vérifier si le bouton existe déjà
    if (document.getElementById('exportButton')) {
        return;
    }

    const btn = document.createElement('button');
    btn.id = 'exportButton';
    btn.className = 'bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full ml-4';
    btn.innerHTML = '<i class="fas fa-file-export mr-3"></i>Exporter en CSV';
    
    btn.onclick = () => {
        // Créer l'en-tête CSV avec tous les champs pertinents
        const header = 'Fournisseur,Contrat,Abonnement (€),Consommation HP (€),Consommation HC (€),Total (€)\n';
        
        // Créer les lignes de données
        const csvData = resultats.map(r => {
            let consoHP = 0;
            let consoHC = 0;
            
            if (r.contrat === 'Tempo') {
                consoHP = r.detailsCouts.bleu.hp + r.detailsCouts.blanc.hp + r.detailsCouts.rouge.hp;
                consoHC = r.detailsCouts.bleu.hc + r.detailsCouts.blanc.hc + r.detailsCouts.rouge.hc;
            } else {
                consoHP = r.detailsCouts.standard.hp;
                consoHC = r.detailsCouts.standard.hc;
            }
            
            return [
                r.fournisseur,
                r.contrat,
                r.coutAbonnement.toFixed(2),
                consoHP.toFixed(2),
                consoHC.toFixed(2),
                r.coutTotal.toFixed(2)
            ].join(',');
        }).join('\n');
        
        // Combiner l'en-tête et les données
        const csv = header + csvData;
        
        // Créer et télécharger le fichier
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', 'comparaison_energie.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    
    // Ajouter le bouton à côté du bouton des statistiques
    const statsButton = document.getElementById('toggleStatsButton');
    statsButton.parentNode.appendChild(btn);
}

function collapseSettings() {
    const $settings = $('#settings');
    const $icon = $('#toggleSettings i.fa-chevron-up');
    const $wrapper = $('#settingsWrapper');

    if (!$settings.hasClass('collapsed')) {
        $settings.addClass('collapsed').slideUp(300);
        $icon.addClass('rotate-180');
        $wrapper.addClass('collapsed');
    }
}

function toggleSettings() {
    const $settings = $('#settings');
    const $icon = $('#toggleSettings i.fa-chevron-up');
    const $wrapper = $('#settingsWrapper');
    const $resultats = $('#resultatContainerWrapper');

    if ($settings.hasClass('collapsed')) {
        // Ouverture des paramètres
        $settings.removeClass('collapsed').slideDown(300);
        $icon.removeClass('rotate-180');
        $wrapper.removeClass('collapsed');
        // Cacher le tableau des résultats
        $resultats.addClass('hidden');
    } else {
        // Fermeture des paramètres
        $settings.addClass('collapsed').slideUp(300);
        $icon.addClass('rotate-180');
        $wrapper.addClass('collapsed');
        // Réafficher le tableau des résultats s'il contient des données
        if ($('#comparaisonTable tbody tr').length > 0) {
            $resultats.removeClass('hidden');
        }
    }
}
function calculerMoyennes(consommation) {
    let totalKwh = 0;
    let totalHP = 0;
    let totalHC = 0;
    if (consommation.hp && consommation.hc) {
        totalHP = Number(consommation.hp);
        totalHC = Number(consommation.hc);
    } else {
        // Pour Tempo
        totalHP = Number(consommation.hpBleu || 0) + Number(consommation.hpBlanc || 0) + Number(consommation.hpRouge || 0);
        totalHC = Number(consommation.hcBleu || 0) + Number(consommation.hcBlanc || 0) + Number(consommation.hcRouge || 0);
    }
    totalKwh = totalHP + totalHC;
    // Calculs des moyennes
    const moyenneJour = totalKwh / 365;
    const moyenneHeure = totalKwh / (365 * 24);
    const moyenneJourHP = totalHP / 365;
    const moyenneJourHC = totalHC / 365;
    const moyenneHeureHP = totalHP / (365 * 16); // Considérant 16h en HP
    const moyenneHeureHC = totalHC / (365 * 8);  // Considérant 8h en HC
    
    // Pourcentages
    const pourcentageHP = (totalHP / totalKwh) * 100;
    const pourcentageHC = (totalHC / totalKwh) * 100;

    // Mise à jour du HTML pour la moyenne journalière
    const moyenneJourHtml = `
        <div class="space-y-2">
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium">Moyenne</span>
                <span class="text-lg font-bold">${moyenneJour.toFixed(1)} kWh</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm">HP (${pourcentageHP.toFixed(1)}%)</span>
                <span class="text-md">${moyenneJourHP.toFixed(1)} kWh</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm">HC (${pourcentageHC.toFixed(1)}%)</span>
                <span class="text-md">${moyenneJourHC.toFixed(1)} kWh</span>
            </div>
            <div class="mt-2 text-xs text-gray-500">
                <i class="fas fa-info-circle mr-1"></i>Équivalent à la consommation quotidienne moyenne de 
                ${(moyenneJour / 2.3).toFixed(1)} personnes
            </div>
        </div>
    `;

    // Mise à jour du HTML pour la moyenne horaire
    const moyenneHeureHtml = `
        <div class="space-y-2">
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium">Moyenne</span>
                <span class="text-lg font-bold">${moyenneHeure.toFixed(2)} kWh</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm">HP (16h/jour)</span>
                <span class="text-md">${moyenneHeureHP.toFixed(2)} kWh</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm">HC (8h/jour)</span>
                <span class="text-md">${moyenneHeureHC.toFixed(2)} kWh</span>
            </div>
            <div class="mt-2 text-xs text-gray-500">
                <i class="fas fa-lightbulb mr-1"></i>Équivalent à ${(moyenneHeure * 1000 / 60).toFixed(0)} ampoules LED de 60W
            </div>
        </div>
    `;

    // Mettre à jour les conteneurs avec les nouvelles données
    $('#moyenneJourContainer').html(moyenneJourHtml);
    $('#moyenneHeureContainer').html(moyenneHeureHtml);
    
    // S'assurer que les conteneurs parents sont visibles
    $('#moyenneJournaliere').removeClass('hidden');
    $('#moyenneHoraire').removeClass('hidden');
}

function updatePourcentages() {
    const contrat = $('#contrat').val();
    
    if (contrat === 'Tempo') {
        // Calculer le total des consommations Tempo
        const totalBleu = Number($('#hpBleu').val() || 0) + Number($('#hcBleu').val() || 0);
        const totalBlanc = Number($('#hpBlanc').val() || 0) + Number($('#hcBlanc').val() || 0);
        const totalRouge = Number($('#hpRouge').val() || 0) + Number($('#hcRouge').val() || 0);
        const total = totalBleu + totalBlanc + totalRouge;

        if (total > 0) {
            // Mettre à jour chaque période
            updatePeriode($('#hpBleu').val(), $('#hcBleu').val(), total, 'Bleu');
            updatePeriode($('#hpBlanc').val(), $('#hcBlanc').val(), total, 'Blanc');
            updatePeriode($('#hpRouge').val(), $('#hcRouge').val(), total, 'Rouge');
        }
    } else {
        // Pour les contrats standard
        const hp = Number($('#hp').val() || 0);
        const hc = Number($('#hc').val() || 0);
        const total = hp + hc;

        if (total > 0) {
            const hpPourcentage = (hp / total) * 100;
            const hcPourcentage = (hc / total) * 100;

            // Mettre à jour les barres de progression
            $('#hpPourcentage').css('width', `${hpPourcentage}%`);
            $('#hcPourcentage').css('width', `${hcPourcentage}%`);

            // Mettre à jour les textes de pourcentage
            $('#hpPourcentageText').text(`${hpPourcentage.toFixed(1)}%`);
            $('#hcPourcentageText').text(`${hcPourcentage.toFixed(1)}%`);
        }
    }
}

// Fonction helper pour mettre à jour les pourcentages Tempo
function updatePeriode(hp, hc, total, prefix) {
    const periodeTotal = Number(hp || 0) + Number(hc || 0);
    if (periodeTotal > 0) {
        const hpValue = Number(hp || 0);
        const hcValue = Number(hc || 0);
        
        // Pourcentages par rapport au total global
        const hpPourcentage = (hpValue / total) * 100;
        const hcPourcentage = (hcValue / total) * 100;
        
        // Mettre à jour les barres de progression
        $(`#hp${prefix}Pourcentage`).css('width', `${hpPourcentage}%`);
        $(`#hc${prefix}Pourcentage`).css('width', `${hcPourcentage}%`);
        
        // Mettre à jour les textes
        $(`#hp${prefix}PourcentageText`).text(`${hpPourcentage.toFixed(1)}%`);
        $(`#hc${prefix}PourcentageText`).text(`${hcPourcentage.toFixed(1)}%`);
    }
} 

// Fonction pour remplir les champs de la modale avec les valeurs actuelles
function remplirChampsCoutMensuelSettings() {
    // Remplir les coefficients de saisonnalité
    Object.entries(coefficientsSaisonnalite).forEach(([mois, valeur]) => {
        const moisFormatted = mois.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        $(`#coef-${moisFormatted}`).val(valeur);
    });
    
    // Remplir les jours rouges
    Object.entries(repartitionJoursRouges).forEach(([mois, valeur]) => {
        const moisFormatted = mois.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        $(`#rouge-${moisFormatted}`).val(valeur);
    });
    
    // Remplir les jours blancs
    Object.entries(repartitionJoursBlancs).forEach(([mois, valeur]) => {
        const moisFormatted = mois.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        $(`#blanc-${moisFormatted}`).val(valeur);
    });
    
    // Mettre à jour les totaux
    updateTotalJoursTempoModal();
}

// Fonction pour mettre à jour les totaux des jours Tempo dans la modale
function updateTotalJoursTempoModal() {
    // Calculer le total des jours rouges
    let totalRouges = 0;
    ['Novembre', 'Décembre', 'Janvier', 'Février', 'Mars'].forEach(mois => {
        const moisFormatted = mois.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const val = parseInt($(`#rouge-${moisFormatted}`).val()) || 0;
        totalRouges += val;
        repartitionJoursRouges[mois] = val;
    });
    $('#total-jours-rouges').text(totalRouges);
    
    // Mettre en évidence si le total n'est pas correct
    $('#total-jours-rouges').toggleClass('text-red-500 font-bold', totalRouges !== 22);
    
    // Calculer le total des jours blancs
    let totalBlancs = 0;
    Object.keys(coefficientsSaisonnalite).forEach(mois => {
        const moisFormatted = mois.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const val = parseInt($(`#blanc-${moisFormatted}`).val()) || 0;
        totalBlancs += val;
        repartitionJoursBlancs[mois] = val;
    });
    $('#total-jours-blancs').text(totalBlancs);
    
    // Mettre en évidence si le total n'est pas correct
    $('#total-jours-blancs').toggleClass('text-red-500 font-bold', totalBlancs !== 43);
}

// Fonction pour sauvegarder les paramètres du graphique de coût mensuel
function sauvegarderParametresCoutMensuel() {
    const parametres = {
        coefficientsSaisonnalite,
        repartitionJoursRouges,
        repartitionJoursBlancs
    };
    
    localStorage.setItem('parametresCoutMensuel', JSON.stringify(parametres));
}

// Fonction pour charger les paramètres du graphique de coût mensuel
function chargerParametresCoutMensuel() {
    const parametres = JSON.parse(localStorage.getItem('parametresCoutMensuel'));
    
    if (parametres) {
        coefficientsSaisonnalite = parametres.coefficientsSaisonnalite;
        repartitionJoursRouges = parametres.repartitionJoursRouges;
        repartitionJoursBlancs = parametres.repartitionJoursBlancs;
    }
}

// Fonction pour importer les coefficients de saisonnalité depuis un fichier JSON
function importerCoefficients(fichier) {
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const contenu = JSON.parse(e.target.result);
         
            // Vérifier si le fichier contient les données attendues (format standard ou format alternatif)
            if (contenu.coefficientsSaisonnalite || contenu.ratios) {
                
                // Déterminer la source des coefficients
                const sourceCoefficients = contenu.coefficientsSaisonnalite || contenu.ratios;
            
                // Mettre à jour les coefficients de saisonnalité
                const mois = ['janvier', 'fevrier', 'mars', 'avril', 'mai', 'juin', 
                             'juillet', 'aout', 'septembre', 'octobre', 'novembre', 'decembre'];
                
                mois.forEach(mois => {
                    // Vérifier le format des données
                   
                    
                    if (sourceCoefficients[mois] !== undefined) {
                        // Format standard: directement la valeur
                        if (typeof sourceCoefficients[mois] === 'number') {
                            
                            $(`#coef-${mois}`).val(sourceCoefficients[mois]);
                        } 
                        // Format alternatif: objet avec propriété ratio
                        else if (sourceCoefficients[mois].ratio !== undefined) {
                            
                            $(`#coef-${mois}`).val(sourceCoefficients[mois].ratio);
                        } else {
                          
                        }
                    } else {
                      
                    }
                });
                
                // Mettre à jour les jours rouges si présents
                if (contenu.repartitionJoursRouges) {
                
                    const moisRouges = ['novembre', 'decembre', 'janvier', 'fevrier', 'mars'];
                    moisRouges.forEach(mois => {
                        if (contenu.repartitionJoursRouges[mois] !== undefined) {
                            $(`#rouge-${mois}`).val(contenu.repartitionJoursRouges[mois]);
                        }
                    });
                } else {
                
                }
                
                // Mettre à jour les jours blancs si présents
                if (contenu.repartitionJoursBlancs) {
                
                    mois.forEach(mois => {
                        if (contenu.repartitionJoursBlancs[mois] !== undefined) {
                            $(`#blanc-${mois}`).val(contenu.repartitionJoursBlancs[mois]);
                        }
                    });
                } else {
                
                }
                
                // Mettre à jour les totaux
                updateTotalJoursTempoModal();
                
                // Afficher un message de succès
                $('#importStatus').html('<span class="text-green-500">Importation réussie!</span>');
                setTimeout(() => {
                    $('#importStatus').html('');
                }, 3000);
            } else {
                console.error("Format invalide: ni coefficientsSaisonnalite ni ratios trouvés", Object.keys(contenu));
                throw new Error("Format de fichier invalide. Le fichier doit contenir un objet 'coefficientsSaisonnalite' ou 'ratios'.");
            }
        } catch (error) {
            console.error("Erreur lors de l'importation:", error);
            $('#importStatus').html(`<span class="text-red-500">Erreur: ${error.message}</span>`);
        }
    };
    
    reader.onerror = function(e) {
        console.error("Erreur de lecture du fichier:", e);
        $('#importStatus').html('<span class="text-red-500">Erreur de lecture du fichier</span>');
    };
    
    reader.readAsText(fichier);
}

// Fonction pour exporter les coefficients actuels au format JSON
function exporterCoefficients(telecharger = true) {
    // Récupérer les valeurs actuelles des coefficients
    const coefficients = {};
    const mois = ['janvier', 'fevrier', 'mars', 'avril', 'mai', 'juin', 
                 'juillet', 'aout', 'septembre', 'octobre', 'novembre', 'decembre'];
    
    mois.forEach(mois => {
        coefficients[mois] = parseFloat($(`#coef-${mois}`).val()) || 0;
    });
    
    // Récupérer les valeurs des jours rouges
    const joursRouges = {};
    const moisRouges = ['novembre', 'decembre', 'janvier', 'fevrier', 'mars'];
    moisRouges.forEach(mois => {
        joursRouges[mois] = parseInt($(`#rouge-${mois}`).val()) || 0;
    });
    
    // Récupérer les valeurs des jours blancs
    const joursBlancs = {};
    mois.forEach(mois => {
        joursBlancs[mois] = parseInt($(`#blanc-${mois}`).val()) || 0;
    });
    
    // Créer l'objet à exporter
    const donnees = {
        coefficientsSaisonnalite: coefficients,
        repartitionJoursRouges: joursRouges,
        repartitionJoursBlancs: joursBlancs
    };
    
    if (!telecharger) {
        return donnees;
    }
    
    // Convertir en JSON
    const jsonString = JSON.stringify(donnees, null, 2);
    
    // Créer un blob et un lien de téléchargement
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    // Créer un lien temporaire pour le téléchargement
    const a = document.createElement('a');
    a.href = url;
    a.download = 'coefficients_saisonnalite.json';
    document.body.appendChild(a);
    a.click();
    
    // Nettoyer
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 0);
}

// Fonction pour convertir le format JSON externe vers le format interne
function convertirFormatJSON(jsonExterne) {
    const formatInterne = {
        coefficientsSaisonnalite: {},
        repartitionJoursRouges: {
            'novembre': 4,
            'decembre': 5,
            'janvier': 6,
            'fevrier': 5,
            'mars': 2
        },
        repartitionJoursBlancs: {
            'janvier': 6,
            'fevrier': 5,
            'mars': 5,
            'avril': 4,
            'mai': 3,
            'juin': 2,
            'juillet': 2,
            'aout': 2,
            'septembre': 3,
            'octobre': 4,
            'novembre': 4,
            'decembre': 3
        }
    };
    
    // Si le JSON externe contient des ratios, les convertir en coefficients
    if (jsonExterne.ratios) {
        const mois = ['janvier', 'fevrier', 'mars', 'avril', 'mai', 'juin', 
                     'juillet', 'aout', 'septembre', 'octobre', 'novembre', 'decembre'];
        
        mois.forEach(mois => {
            if (jsonExterne.ratios[mois] && jsonExterne.ratios[mois].ratio !== undefined) {
                formatInterne.coefficientsSaisonnalite[mois] = jsonExterne.ratios[mois].ratio;
            }
        });
    }
    
    return formatInterne;
}

// Fonction pour exporter au format compatible avec l'importation
function exporterFormatCompatible() {
    const donnees = exporterCoefficients(false);
    
    // Convertir au format attendu par l'importation
    const formatExterne = {
        mode: "base",
        date: new Date().toISOString(),
        ratios: {},
        totalConsumption: 12000,
        monthlyAverage: 1000
    };
    
    // Convertir les coefficients en ratios
    const mois = ['janvier', 'fevrier', 'mars', 'avril', 'mai', 'juin', 
                 'juillet', 'aout', 'septembre', 'octobre', 'novembre', 'decembre'];
    
    mois.forEach(mois => {
        const valeur = donnees.coefficientsSaisonnalite[mois] || 1;
        formatExterne.ratios[mois] = {
            value: Math.round(valeur * 1000),
            ratio: parseFloat(valeur)
        };
    });
    
    return formatExterne;
} 

// Fonction pour vérifier et corriger l'état des conteneurs
function verifierEtatConteneurs() {
    const analysesContainer = $('#analysesContainer');
    const resultatContainer = $('#resultatContainer');
    const button = $('#toggleStatsButton');
    
    // Forcer l'état correct si les deux conteneurs sont cachés ou visibles en même temps
    if ((analysesContainer.hasClass('hidden') && resultatContainer.hasClass('hidden')) || 
        (!analysesContainer.hasClass('hidden') && !resultatContainer.hasClass('hidden'))) {
     
        resultatContainer.removeClass('hidden').show();
        analysesContainer.addClass('hidden').hide();
        button.html('<i class="fas fa-chart-bar mr-3"></i>Afficher les stats')
            .removeClass('bg-green-500 hover:bg-green-700')
            .addClass('bg-blue-500 hover:bg-blue-700');
    }
}

// Ajouter un appel à cette fonction après le chargement de la page
$(document).ready(function() {
    
    // Vérifier l'état des conteneurs après le chargement
    setTimeout(verifierEtatConteneurs, 1000);
    
    // Ajouter un gestionnaire d'événements supplémentaire pour le bouton
    $('#toggleStatsButton').off('click.debug').on('click.debug', function() {
        setTimeout(verifierEtatConteneurs, 600);
    });

});